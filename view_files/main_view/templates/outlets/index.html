{% extends "main_base.html" %}
{% load i18n static %}

{% block template_css %}
{% endblock %}

{% block title %}
{{ title|default:"" }}
{% endblock %}

{% block page_title %}
<div class="block-item">
    <h4>Outlets</h4>
</div>
{% endblock %}

{% block content %}
<div id="common-list-page">
    <section class="content-section">
        <div class="custom-container">
            <div class="section-content">
                {% if messages %}
                {% for message in messages %}
                <div class="alert alert-success"> {{ message}} </div>
                {% endfor %}
                {% endif %}

                <div class="common-content-box">
                    <div class="common-table">
                        <div class="title-container">
                            <div class="title-item">
                                <div class="inner-item">
                                    <a href="{% url 'admin_outlet_create' %}" class="co-btn">Add Outlet</a>
                                </div>
                            </div>
                        </div>

                        <table id="basic-datatable">
                            <thead>
                                <tr>
                                    <td>SN</td>
                                    <td>Image</td>
                                    <td>Name</td>
                                    <td>Address</td>
                                    <td>Mobile</td>
                                    <td class="text-end wd-sm">Action</td>
                                </tr>
                            </thead>

                            {% csrf_token %}
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block js %}
<script>
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
var dt;
var table;

var KTDatatablesServerSide = function () {
    table;
    dt;

    function initDatatable(status = true) {
        dt = $("#basic-datatable").DataTable({
            searchDelay: 500,
            processing: true,
            serverSide: true,
            ordering: false,
            pageLength: 25,
            order: [[2, 'asc']],
            stateSave: true,
            destroy: true,
            select: {
                style: 'multi',
                selector: 'td:first-child input[type="checkbox"]',
                className: 'row-selected'
            },
            'ajax': { url: "{% url 'admin_outlet_index' %}", type: 'POST', data: { 'csrfmiddlewaretoken': csrftoken } },
            columns: [
                {
                    data: function (data, type, row, meta) {
                        return meta.row + meta.settings._iDisplayStart + 1;
                    },
                    name: "sn", searchable: false, sortable: false
                },
                {
                    data: function (data) {
                        if (data.image) {
                            return `<span class="image-container"><img src="${data.image}"></span>`;
                        } else {
                            return `<span class="image-container"><img src="{% static 'imagio_theme/img/placeholder/placeholder-rectangle.jpg' %}"></span>`;
                        }
                    },
                    name: "image", searchable: false
                },
                { data: "name", name: "name" },
                { data: "address", name: "address" },
                { data: "mobile", name: "mobile" },
                {
                    data: function (data, b, c, table) {
                        var buttons = '';
                        buttons += '<td>'
                        buttons += '<ul class="type-action">'
                        buttons += '<li>'
                        buttons += '<div class="dropdown">'
                        buttons += '<button class="dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">'
                        buttons += '<i class="flaticon-more"></i>'
                        buttons += '</button>'
                        buttons += '<ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">'
                        buttons += '<li><a class="dropdown-item" href="/admin/outlets/' + data.id + '/services/">Manage Services</a></li>'
                        buttons += `<li><a class="dropdown-item" href="{% url 'admin_outlet_edit' %}?id=` + data.id + `">Edit</a></li>`
                        buttons += '<li><a class="dropdown-item type-delete" onclick="delete_json(' + data.id + ')" href="javascript::void(0)" title="Delete">Delete</a></li>'
                        buttons += '</ul>'
                        buttons += '</div>'
                        buttons += '</li>'
                        buttons += '</ul>'
                        buttons += '</td>'
                        return buttons
                    }, name: 'action', searchable: false
                },
            ],
            createdRow: function (row, data, dataIndex) {
                $(row).find('td:eq(3)').attr('data-filter');
            }
        });

        table = dt.$;
        dt.on('draw', function () {
            KTMenu.createInstances();
        });
    }

    return {
        init: function () {
            initDatatable();
        }
    }
}();

$('.alert-success').fadeOut(5000);

$(document).ready(function () {
    KTDatatablesServerSide.init();
});

function delete_json(id) {
    alertify.confirm('Do you want to delete this item?', function () {
        $.post("{% url 'admin_outlet_delete' %}", { id: id, csrfmiddlewaretoken: csrftoken }, function () {
            dt.ajax.reload(null, false);
        });
    });
}

function goToOutletServices(outlet_id) {
    if(outlet_id) {
        window.location.href = `/admin/outlets/${outlet_id}/services/`;
    } else {
        alert('Outlet ID missing!');
    }
}
</script>
{% endblock %}
